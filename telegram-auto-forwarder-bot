import requests
import re
import time

# SOZLAMALAR (O'zingiznikiga o'zgartiring)
TOKEN = "YOUR_TOKEN_HERE" # BotFather bergan token
KANAL_NOMI = "@meningkanalim" # Xabarlar boradigan kanalingiz
YANGI_YOZUV = "@meningkanalim" # Boshqa linklar o'rniga nima yozilishi kerak?

# Muntazam ifoda (RegEx) - @username va barcha turdagi linklarni topish uchun
# Bu qator @ bilan boshlanadigan so'zlarni yoki http/https/t.me bilan boshlanadigan linklarni topadi
QIDIRUV_ANDOZASI = r'@[A-Za-z0-9_]+|https?://[^\s]+|t\.me/[^\s]+'

def get_updates(offset=None):
    """Botga kelgan yangi xabarlarni oladi"""
    url = f"https://api.telegram.org/bot{TOKEN}/getUpdates"
    params = {"timeout": 100, "offset": offset}
    response = requests.get(url, params=params)
    return response.json()

def matnni_tahrirlash(matn):
    """Matn ichidagi begona link va usernamelarni o'chirib, o'zimiznikini qoyadi"""
    if not matn:
        return ""
    # re.sub orqali topilgan linklarni YANGI_YOZUV ga almashtiramiz
    tahrirlangan_matn = re.sub(QIDIRUV_ANDOZASI, YANGI_YOZUV, matn)
    return tahrirlangan_matn

def xabarni_jo_natish(xabar):
    """Xabarni turiga qarab kanalga jo'natadi"""
    chat_id = xabar["chat"]["id"]
    xabar_id = xabar["message_id"]
    
    # Xabarda oddiy matn bormi yoki rasm/video tagidagi matn (caption) bormi?
    asl_matn = xabar.get("text") or xabar.get("caption") or ""
    
    # Matnni tahrirlaymiz
    tozalan_matn = matnni_tahrirlash(asl_matn)

    # 1. Agar xabar faqat matndan iborat bo'lsa (text)
    if "text" in xabar:
        url = f"https://api.telegram.org/bot{TOKEN}/sendMessage"
        params = {
            "chat_id": KANAL_NOMI,
            "text": tozalan_matn
        }
        requests.post(url, params=params)
        print(f"Matn yuborildi: {tozalan_matn}")

    # 2. Agar xabar rasm, video, hujjat yoki audio bo'lsa
    elif any(k in xabar for k in ("photo", "video", "document", "audio", "animation")):
        # copyMessage orqali mediani o'zini olib, tagiga yangi matnni yozib jo'natamiz
        url = f"https://api.telegram.org/bot{TOKEN}/copyMessage"
        params = {
            "chat_id": KANAL_NOMI,
            "from_chat_id": chat_id,
            "message_id": xabar_id,
            "caption": tozalan_matn # Eski caption o'rniga tozalanganini qo'yamiz
        }
        requests.post(url, params=params)
        print("Media xabar yangi matn bilan yuborildi.")

def main():
    print("Bot ishga tushdi va xabarlarni kutmoqda...")
    offset = None
    
    while True:
        try:
            yangiliklar = get_updates(offset)
            
            if "result" in yangiliklar:
                for yangilik in yangiliklar["result"]:
                    # Keyingi safar xuddi shu xabarni yana o'qimasligi uchun offsetni yangilaymiz
                    offset = yangilik["update_id"] + 1
                    
                    if "message" in yangilik:
                        xabar = yangilik["message"]
                        xabarni_jo_natish(xabar)
                        
            # API ni ortiqcha zo'riqtirmaslik uchun 1 soniya kutamiz
            time.sleep(1)
            
        except Exception as e:
            print(f"Xatolik yuz berdi: {e}")
            time.sleep(5)

if __name__ == "__main__":
    main()